#cloud-config

# Complete VM setup for k3a cluster nodes
# Includes all packages needed for Kubernetes/kubeadm installation

package_update: true

packages:
  - curl
  - wget
  - git
  - unzip
  - ca-certificates
  - moby-runc
  - moby-containerd

# Complete system setup for Kubernetes
runcmd:
  # Install Azure CLI for CBL-Mariner (RPM-based)
  - sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
  - |
    cat <<EOF | sudo tee /etc/yum.repos.d/azure-cli.repo
    [azure-cli]
    name=Azure CLI
    baseurl=https://packages.microsoft.com/yumrepos/azure-cli
    enabled=1
    gpgcheck=1
    gpgkey=https://packages.microsoft.com/keys/microsoft.asc
    EOF
  - sudo tdnf install -y azure-cli
  
  # Setup container runtime
  - sudo systemctl enable --now containerd
  - sudo mkdir -p /etc/containerd
  - sudo containerd config default | sudo tee /etc/containerd/config.toml
  - sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
  - sudo systemctl restart containerd
  
  # Setup Kubernetes kernel modules and networking
  - |
    sudo tee /etc/modules-load.d/k8s.conf <<EOF
    overlay
    br_netfilter
    EOF
  - sudo modprobe overlay
  - sudo modprobe br_netfilter
  - |
    sudo tee /etc/sysctl.d/k8s.conf <<EOF
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward                 = 1
    EOF
  - sudo sysctl --system
  
  # Disable swap
  - sudo swapoff -a
  - sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  
  # Setup Kubernetes repository and install packages
  - |
    sudo tee /etc/yum.repos.d/kubernetes.repo <<EOF
    [kubernetes]
    name=Kubernetes
    baseurl=https://pkgs.k8s.io/core:/stable:/v1.33/rpm/
    enabled=1
    gpgcheck=1
    gpgkey=https://pkgs.k8s.io/core:/stable:/v1.33/rpm/repodata/repomd.xml.key
    EOF
  - sudo tdnf install -y kubelet kubeadm kubectl
  - sudo systemctl enable kubelet
  
  # Ensure azureuser has proper SSH directory
  - sudo -u azureuser mkdir -p /home/azureuser/.ssh
  - sudo -u azureuser chmod 700 /home/azureuser/.ssh
  
  # Set hostname based on instance metadata (if available)
  - |
    INSTANCE_NAME=$(curl -s -H Metadata:true "http://169.254.169.254/metadata/instance/compute/name?api-version=2021-02-01&format=text" 2>/dev/null || echo "k3a-node")
    hostnamectl set-hostname "$INSTANCE_NAME"
  
  # Basic system optimization
  - echo 'vm.swappiness=10' >> /etc/sysctl.conf
  - sysctl -p

write_files:
  # Create a marker file to indicate cloud-init completion
  - path: /var/lib/cloud/k3a-ready
    content: |
      Cloud-init setup completed for k3a cluster node
      All Kubernetes prerequisites installed
      Timestamp: $(date)
    permissions: '0644'

# Ensure services are enabled
bootcmd:
  - systemctl enable ssh

# Final message
final_message: "k3a node cloud-init setup completed. All prerequisites installed. Ready for kubeadm cluster initialization via SSH."
